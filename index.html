<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>El Laboratorio de la Diversi√≥n: Detective de Emociones</title>
<style>
  /* =========================
     VARIABLES Y RESET
     ========================= */
  :root{
    --bg-lab: radial-gradient(circle at 50% -20%, #2b4560, #0b0f14);
    --bg-park: linear-gradient(180deg, #87CEEB 0%, #E0F7FA 60%, #7CFC00 60%, #228B22 100%);
    --bg-home: radial-gradient(circle at 50% 50%, #6d5843, #2e2015);
    --bg-dark: radial-gradient(circle at 50% 50%, #1a1a2e, #000000);
    
    --panel: rgba(18, 25, 35, 0.95);
    --panel-border: rgba(255,255,255,0.15);
    
    --accent: #51e5a8;
    --accent-2: #00c2ff;
    --warning: #ffb400;
    --danger: #ff5577;
    --ok: #7CFF7C;
    --text: #f2f6fb;
    --muted: #a8b6c7;
    
    --shadow: 0 10px 40px rgba(0,0,0,0.5);
    --radius: 20px;
    --font-main: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; padding:0}
  
  body{
    font-family: var(--font-main);
    background: #0b0f14; /* Fallback */
    color: var(--text);
    transition: background 1s ease; /* Transici√≥n suave de fondos */
    overflow-x: hidden;
  }

  /* Clases de Ambiente (Backgrounds) */
  body.mode-lab { background: var(--bg-lab); }
  body.mode-park { background: var(--bg-park); }
  body.mode-home { background: var(--bg-home); }
  body.mode-dark { background: var(--bg-dark); }

  /* =========================
     LAYOUT
     ========================= */
  .container{
    max-width:1200px;
    margin:auto;
    padding:16px;
    display:grid;
    gap:20px;
    grid-template-rows: auto 1fr auto;
    min-height:100dvh;
    position: relative;
    z-index: 2;
  }

  /* Header */
  header{
    background: var(--panel);
    border: 1px solid var(--panel-border);
    border-radius: var(--radius);
    padding: 12px 20px;
    box-shadow: var(--shadow);
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
    backdrop-filter: blur(10px);
  }
  .brand{ display:flex; align-items:center; gap:12px; font-weight:700; font-size: 1.1rem; }
  .logo{
    width:44px; height:44px; border-radius:12px;
    background:conic-gradient(from 180deg, var(--accent), var(--accent-2));
    box-shadow: inset 0 0 0 4px rgba(0,0,0,0.3);
  }
  
  /* Botones Generales */
  .btn{
    border:none; padding:10px 16px; border-radius:12px;
    cursor:pointer; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;
    transition: all 0.2s ease; font-size: 0.9rem; display:inline-flex; align-items:center; gap:8px;
    color: white;
    background: #2a3b55;
    box-shadow: 0 4px 0 rgba(0,0,0,0.3);
  }
  .btn:active{ transform:translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }
  .btn:disabled{ opacity:0.5; cursor:not-allowed; filter:grayscale(1); }

  .btn.primary{ background: linear-gradient(to bottom, #00c2ff, #0077ff); }
  .btn.good{ background: linear-gradient(to bottom, #51e5a8, #2b9e6e); color:#08291a; }
  .btn.warn{ background: linear-gradient(to bottom, #ffb400, #c48000); color:#2e1c00; }
  .btn.ghost{ background: rgba(255,255,255,0.1); box-shadow:none; }
  .btn.ghost:hover{ background: rgba(255,255,255,0.2); }

  /* Controls Group (ocultos al inicio) */
  .controls { display:flex; gap:10px; flex-wrap:wrap; }
  .controls.hidden { display:none; }

  /* =========================
     GRID PRINCIPAL
     ========================= */
  main{
    display:grid; gap:20px; grid-template-columns: 340px 1fr;
  }
  @media (max-width: 900px){ main{ grid-template-columns: 1fr; } }

  /* Paneles */
  .panel{
    background: var(--panel); border:1px solid var(--panel-border);
    border-radius: var(--radius); padding:20px; box-shadow: var(--shadow);
    backdrop-filter: blur(5px);
  }

  /* Zippy Avatar */
  .zippy-container{
    text-align:center; position:relative; margin-bottom:20px;
    background: rgba(0,0,0,0.3); border-radius:16px; padding:20px 0;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .zippy{ width:160px; height:auto; filter:drop-shadow(0 10px 10px rgba(0,0,0,0.5)); animation: float 4s ease-in-out infinite; }
  @keyframes float{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

  /* Medidores */
  .meter-group{ display:grid; gap:12px; margin-bottom:24px; }
  .meter label{ display:flex; justify-content:space-between; font-size:0.85rem; font-weight:700; margin-bottom:4px; color:var(--muted); text-transform:uppercase; }
  .bar-bg{ height:14px; background:rgba(0,0,0,0.4); border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,0.1); }
  .bar-fill{ height:100%; width:0%; transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1); background: var(--accent); }
  
  /* Colores espec√≠ficos barras */
  .meter.energy .bar-fill { background: linear-gradient(90deg, #FFD700, #ff8c00); }
  .meter.social .bar-fill { background: linear-gradient(90deg, #ff7eb3, #ff758c); }
  .meter.attention .bar-fill { background: linear-gradient(90deg, #00c2ff, #0077ff); }

  /* Men√∫ Experimentos */
  .exp-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
  .exp-btn{
    background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:12px;
    padding:10px 4px; display:flex; flex-direction:column; align-items:center; gap:6px;
    cursor:pointer; transition: .2s; color: var(--muted); position: relative;
  }
  .exp-btn:hover{ background: rgba(255,255,255,0.1); transform:translateY(-2px); color:white; }
  .exp-btn.completed { border-color: var(--ok); background: rgba(124, 255, 124, 0.1); }
  .exp-btn svg{ width:32px; height:32px; opacity:0.8; }
  .exp-btn span{ font-size:0.7rem; text-align:center; line-height:1.1; }
  
  .check-icon{
    position:absolute; top:-6px; right:-6px; width:18px; height:18px; background:var(--ok);
    color:black; border-radius:50%; display:grid; place-items:center; font-weight:bold; font-size:12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3); transform: scale(0); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .exp-btn.completed .check-icon { transform: scale(1); }

  /* Area Derecha (Escenario) */
  .stage-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; }
  .stage-title{ font-size:1.4rem; margin:0; color:white; }
  
  /* Tarjetas de Contenido */
  .card{ background: rgba(0,0,0,0.2); border-radius:16px; padding:20px; animation: fadeIn 0.5s ease; border:1px solid rgba(255,255,255,0.05); }
  @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
  
  .visual-scene{
    height: 220px; background: rgba(0,0,0,0.3); border-radius:12px; margin-bottom:16px;
    display:flex; justify-content:center; align-items:center; position:relative; overflow:hidden;
    border: 1px solid rgba(255,255,255,0.1);
  }
  .narrative-text{ font-size:1.1rem; line-height:1.6; margin-bottom:20px; color: #e0e6ed; }
  .narrative-text strong { color: var(--accent-2); }
  
  /* Overlay de T√≠tulo (Start Screen) */
  #titleScreen {
    position: fixed; inset:0; background: rgba(11, 15, 20, 0.95); z-index: 100;
    display:flex; flex-direction:column; justify-content:center; align-items:center; gap:20px;
    backdrop-filter: blur(10px); text-align:center; padding:20px;
  }
  .big-logo { width: 100px; height: 100px; background: conic-gradient(from 180deg, var(--accent), var(--accent-2)); border-radius: 24px; margin-bottom: 20px; box-shadow: 0 0 50px rgba(81, 229, 168, 0.3); }
  .hero-title { font-size: 2.5rem; margin:0; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; color: transparent; }
  
  .pulse-btn {
    font-size: 1.5rem; padding: 16px 40px; border-radius: 50px;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    color: #0b0f14; border:none; font-weight: 800;
    box-shadow: 0 0 0 0 rgba(81, 229, 168, 0.7);
    animation: pulse-green 2s infinite; cursor: pointer;
    margin-top: 20px;
  }
  @keyframes pulse-green {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(81, 229, 168, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(81, 229, 168, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(81, 229, 168, 0); }
  }
  
  .arrow-hint { font-size: 2rem; animation: bounceArrow 1s infinite; color: var(--accent); }
  @keyframes bounceArrow { 0%,100%{transform:translateY(0)} 50%{transform:translateY(10px)} }

  /* Quiz Styles */
  .quiz-opts { display: grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px; }
  .q-btn {
    background: #1c2633; border: 2px solid #2a3b55; padding: 20px; border-radius: 16px;
    display:flex; flex-direction:column; align-items:center; gap:10px; cursor: pointer; transition: .2s;
  }
  .q-btn:hover { border-color: var(--accent-2); background: #233040; transform: translateY(-3px); }
  .q-btn.correct { border-color: var(--ok); background: rgba(124, 255, 124, 0.15); }
  .q-btn.wrong { border-color: var(--danger); background: rgba(255, 85, 119, 0.15); animation: shake 0.4s; }
  
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

  /* Footer */
  footer{ text-align:center; padding:20px; color:var(--muted); font-size:0.85rem; }

</style>
</head>
<body class="mode-lab">

  <!-- PANTALLA DE INICIO (Overlay) -->
  <div id="titleScreen">
    <div class="big-logo"></div>
    <h1 class="hero-title">El Laboratorio de la<br>Diversi√≥n</h1>
    <p style="font-size:1.2rem; color:#a8b6c7; max-width:600px;">
      Convi√©rtete en un Detective de Emociones. <br>Ayuda a Zippy a descubrir c√≥mo equilibrar el mundo digital y el real.
    </p>
    <div class="arrow-hint">‚Üì</div>
    <button class="pulse-btn" id="btnBigStart">¬°INICIAR MISI√ìN!</button>
  </div>

  <div class="container" role="main">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div>DETECTIVE DE EMOCIONES</div>
          <small style="font-weight:400; color:var(--muted)">Bienestar Digital</small>
        </div>
      </div>
      
      <!-- Controles ocultos inicialmente -->
      <div class="controls hidden" id="mainControls">
        <button id="btnMap" class="btn ghost">üó∫Ô∏è Volver al Lab</button>
        <button id="btnMute" class="btn ghost">üîä Sonido ON</button>
      </div>
    </header>

    <main>
      <!-- Panel Izquierdo: Zippy y Status -->
      <aside class="panel">
        <div class="zippy-container">
          <!-- Zippy SVG -->
          <svg class="zippy" viewBox="0 0 200 200">
            <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#51e5a8"/><stop offset="1" stop-color="#00c2ff"/></linearGradient></defs>
            <circle cx="100" cy="100" r="80" fill="#0f2133" stroke="url(#g1)" stroke-width="4"/>
            <rect x="60" y="40" width="80" height="60" rx="16" fill="#10243a" stroke="#1e4766" stroke-width="3"/>
            <circle cx="85" cy="70" r="8" fill="#50e8b2"/><circle cx="115" cy="70" r="8" fill="#50e8b2"/>
            <rect x="78" y="86" width="44" height="6" rx="3" fill="#1d91c4"/>
            <line x1="100" y1="40" x2="100" y2="25" stroke="#1d91c4" stroke-width="3"/>
            <circle cx="100" cy="22" r="5" fill="#51e5a8"/>
            <rect x="28" y="96" width="24" height="8" rx="4" fill="#1a3350"/>
            <rect x="148" y="96" width="24" height="8" rx="4" fill="#1a3350"/>
          </svg>
        </div>

        <div class="meter-group">
          <div class="meter energy">
            <label>‚ö° Energ√≠a F√≠sica <span id="valEnergy">0%</span></label>
            <div class="bar-bg"><div class="bar-fill" id="fillEnergy" style="width:0%"></div></div>
          </div>
          <div class="meter social">
            <label>ü§ù Conexi√≥n Social <span id="valSocial">0%</span></label>
            <div class="bar-bg"><div class="bar-fill" id="fillSocial" style="width:0%"></div></div>
          </div>
          <!-- Atenci√≥n (oculta por defecto) -->
          <div class="meter attention" id="meterAttention" style="display:none">
            <label>üéØ Atenci√≥n <span id="valAttention">50%</span></label>
            <div class="bar-bg"><div class="bar-fill" id="fillAttention" style="width:50%"></div></div>
          </div>
        </div>

        <h3 style="margin:0 0 10px 0; font-size:0.9rem; text-transform:uppercase; letter-spacing:1px; color:var(--muted)">Experimentos</h3>
        <div class="exp-grid" id="expMenu">
          <!-- Botones generados por JS -->
        </div>
      </aside>

      <!-- Panel Derecho: Escenario Din√°mico -->
      <section class="panel">
        <div class="stage-header">
          <h2 class="stage-title" id="stageTitle">Briefing</h2>
          <span style="font-size:0.8rem; background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:20px" id="stageTag">Tutorial</span>
        </div>
        
        <div id="gameContent">
          <!-- El contenido se inyecta aqu√≠ -->
        </div>
      </section>
    </main>

    <footer>
      ¬© Gnius Club 2025 ‚Ä¢ Aprendiendo a equilibrar la vida digital y real.
    </footer>
  </div>

<script>
/* ============================================================
   L√ìGICA DEL JUEGO
   ============================================================ */

const state = {
  currentStage: 'start', // start, lab, exp, quiz, win
  muted: false,
  meters: { energy: 30, social: 30, attention: 50 },
  completed: { logica:false, online:false, shorts:false, movie:false, park:false },
  quizIndex: 0,
  quizScore: 0
};

// Configuraci√≥n de Experimentos
const experiments = {
  logica: {
    id: 'logica', name: 'Reto L√≥gica', icon: 'üß©', room: 'mode-lab', affectsAttention: true,
    desc: 'Zippy resuelve puzzles. Bueno para la mente, pero el cuerpo no se mueve.',
    result: 'Mente activa, cuerpo quieto.',
    animSVG: `<rect x="50" y="50" width="100" height="70" rx="5" fill="#333" stroke="#555"/><path d="M60 60h80v50h-80z" fill="#000"/><text x="85" y="95" fill="#0f0" font-family="monospace" font-size="20">E=mc¬≤</text>`,
    apply: () => updateMeters(-10, -5, +30)
  },
  online: {
    id: 'online', name: 'Juego Online', icon: 'üéÆ', room: 'mode-dark', affectsAttention: false,
    desc: 'Zippy juega solo en su cuarto oscuro. Es divertido, pero se siente solo.',
    result: 'Cuerpo tenso, baja conexi√≥n social.',
    animSVG: `<rect x="0" y="0" width="100%" height="100%" fill="#111"/><circle cx="100" cy="100" r="40" fill="rgba(0,100,255,0.2)" filter="blur(10px)"/><text x="70" y="110" font-size="40">üëæ</text>`,
    apply: () => updateMeters(-20, -20, 0)
  },
  shorts: {
    id: 'shorts', name: 'Videos R√°pidos', icon: 'üì±', room: 'mode-dark', affectsAttention: true,
    desc: 'Cientos de videos en segundos. Zippy termina mareado y con ojos rojos.',
    result: 'Atenci√≥n agotada, ojos cansados.',
    animSVG: `<text x="80" y="100" font-size="50" class="spin">üòµ‚Äçüí´</text><style>.spin{transform-origin:center; animation:spin 1s infinite linear}@keyframes spin{to{transform:rotate(360deg)}}</style>`,
    apply: () => { state.meters.attention=0; updateMeters(-10, 0, 0); }
  },
  movie: {
    id: 'movie', name: 'Cine Familia', icon: 'üçø', room: 'mode-home', affectsAttention: false,
    desc: 'Pel√≠cula en el sof√° con amigos robots. Risas y relajaci√≥n.',
    result: 'Relajado y conectado.',
    animSVG: `<rect x="20" y="120" width="160" height="60" rx="10" fill="#8B4513"/><circle cx="60" cy="100" r="20" fill="#aaa"/><circle cx="100" cy="100" r="20" fill="#aaa"/><circle cx="140" cy="100" r="20" fill="#aaa"/><text x="90" y="80" font-size="30">üòÇ</text>`,
    apply: () => updateMeters(+10, +40, 0)
  },
  park: {
    id: 'park', name: 'F√∫tbol Parque', icon: '‚öΩ', room: 'mode-park', affectsAttention: false,
    desc: 'Aire libre, correr y chocar los cinco. ¬°Energ√≠a total!',
    result: '¬°Energ√≠a y amigos al m√°ximo!',
    animSVG: `<rect x="0" y="150" width="200" height="50" fill="#228B22"/><circle cx="150" cy="40" r="20" fill="yellow"/><text x="20" y="140" font-size="40" class="bounce">‚öΩ</text><style>.bounce{animation:b 0.8s infinite alternate}@keyframes b{to{transform:translateY(-80px)}}</style>`,
    apply: () => { state.meters.energy=100; state.meters.social=100; updateMeters(0,0,0); }
  }
};

// Preguntas del Examen
const quizData = [
  { q: "¬øQu√© actividad te da m√°s energ√≠a y amigos?", a: "F√∫tbol Parque", icon: "‚öΩ", correct:0, opts:[ {txt:"F√∫tbol Parque", i:"‚öΩ"}, {txt:"Juego Online Solo", i:"üéÆ"} ] },
  { q: "¬øQu√© cansa m√°s tus ojos y baja tu atenci√≥n?", a: "Videos R√°pidos", icon: "üì±", correct:1, opts:[ {txt:"Armar un Puzzle", i:"üß©"}, {txt:"Videos R√°pidos", i:"üì±"} ] },
  { q: "¬øCu√°l es mejor para no sentirse solo?", a: "Cine Familia", icon: "üçø", correct:0, opts:[ {txt:"Cine Familia", i:"üçø"}, {txt:"Estar solo en cuarto oscuro", i:"üëæ"} ] }
];

/* ============================================================
   DOM ELEMENTS & UTILS
   ============================================================ */
const $ = id => document.getElementById(id);
const speak = (txt) => {
  if(state.muted) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = 'es-MX'; u.rate=1.1;
  window.speechSynthesis.speak(u);
};
const playSound = (type) => {
  if(state.muted) return;
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = ctx.createOscillator(); const g = ctx.createGain();
  osc.connect(g); g.connect(ctx.destination);
  if(type==='win'){
    osc.type='triangle'; osc.frequency.setValueAtTime(523, ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(1046, ctx.currentTime+0.1);
    g.gain.setValueAtTime(0.1, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.3);
    osc.start(); osc.stop(ctx.currentTime+0.3);
  } else if(type==='err'){
    osc.type='sawtooth'; osc.frequency.value=150;
    g.gain.value=0.1; osc.start(); osc.stop(ctx.currentTime+0.2);
  } else {
    // Click
    osc.frequency.value=800; g.gain.value=0.05; osc.start(); osc.stop(ctx.currentTime+0.05);
  }
};

function updateMeters(eDelta, sDelta, aDelta){
  state.meters.energy = Math.max(0, Math.min(100, state.meters.energy + eDelta));
  state.meters.social = Math.max(0, Math.min(100, state.meters.social + sDelta));
  state.meters.attention = Math.max(0, Math.min(100, state.meters.attention + aDelta));
  
  $('fillEnergy').style.width = state.meters.energy + '%'; $('valEnergy').textContent = state.meters.energy + '%';
  $('fillSocial').style.width = state.meters.social + '%'; $('valSocial').textContent = state.meters.social + '%';
  $('fillAttention').style.width = state.meters.attention + '%'; $('valAttention').textContent = state.meters.attention + '%';
}

function setRoom(cls){
  document.body.className = cls;
}

/* ============================================================
   RENDERIZADORES DE ESCENA
   ============================================================ */

function renderMenu(){
  const menu = $('expMenu');
  menu.innerHTML = '';
  Object.values(experiments).forEach(exp => {
    const btn = document.createElement('div');
    btn.className = `exp-btn ${state.completed[exp.id] ? 'completed' : ''}`;
    btn.onclick = () => { if(state.currentStage === 'lab') loadExperiment(exp.id); };
    btn.innerHTML = `
      <div class="check-icon">‚úì</div>
      <div style="font-size:24px">${exp.icon}</div>
      <span>${exp.name}</span>
    `;
    menu.appendChild(btn);
  });
}

// 1. BRIEFING / TUTORIAL
function startBriefing(){
  $('titleScreen').style.display = 'none';
  $('mainControls').classList.remove('hidden');
  state.currentStage = 'briefing';
  setRoom('mode-lab');
  
  $('stageTitle').textContent = "Introducci√≥n";
  $('stageTag').textContent = "Laboratorio";
  $('gameContent').innerHTML = `
    <div class="card">
      <div class="visual-scene">
        <svg width="100" height="100" viewBox="0 0 100 100">
           <circle cx="50" cy="50" r="45" fill="#2b4560" stroke="#51e5a8" stroke-width="2"/>
           <rect x="35" y="35" width="30" height="30" fill="#fff"/>
        </svg>
      </div>
      <p class="narrative-text">
        <strong>Directora:</strong> "¬°Hola Detective! Ese es Zippy. Tu misi√≥n es probar diferentes actividades y ver c√≥mo cambian su <strong>Energ√≠a</strong> y sus <strong>Emociones</strong>."
      </p>
      <button class="btn good" style="width:100%" onclick="goToLab()">¬°Entendido, vamos al Lab!</button>
    </div>
  `;
  speak("Hola Detective. Tu misi√≥n es probar actividades y ver c√≥mo cambian la energ√≠a y emociones de Zippy. Vamos al laboratorio.");
  renderMenu();
}

// 2. LABORATORIO HUB
function goToLab(){
  state.currentStage = 'lab';
  setRoom('mode-lab');
  $('meterAttention').style.display = 'none';
  $('stageTitle').textContent = "Sala de Experimentos";
  $('stageTag').textContent = "Elige una actividad";
  
  // Check if all done
  const allDone = Object.values(state.completed).every(x=>x);
  
  $('gameContent').innerHTML = `
    <div class="card">
      <p class="narrative-text">
        Selecciona un experimento del panel izquierdo (los botones peque√±os) para ver qu√© pasa con Zippy.
      </p>
      <div style="margin-top:20px; text-align:center">
        ${allDone 
          ? `<button class="btn pulse-btn" style="font-size:1rem; padding:12px 24px" onclick="startQuiz()">Ir al Desaf√≠o Final üèÜ</button>`
          : `<p style="color:var(--muted)">Completa los 5 experimentos para desbloquear el examen.</p>`
        }
      </div>
    </div>
  `;
  renderMenu();
  if(!allDone) speak("Selecciona un experimento del men√∫ para comenzar.");
  else speak("Has completado todos los experimentos. Ve al desaf√≠o final.");
}

// 3. EXPERIMENTO
function loadExperiment(id){
  const exp = experiments[id];
  state.currentStage = 'exp';
  setRoom(exp.room);
  
  $('stageTitle').textContent = exp.name;
  $('stageTag').textContent = "Observando...";
  $('meterAttention').style.display = exp.affectsAttention ? 'block' : 'none';
  
  $('gameContent').innerHTML = `
    <div class="card">
      <div class="visual-scene">
        <svg viewBox="0 0 200 200" width="100%" height="100%">
          ${exp.animSVG}
        </svg>
      </div>
      <p class="narrative-text" id="expText">${exp.desc}</p>
      <div style="display:flex; gap:10px">
        <button class="btn primary" id="btnRunExp" onclick="runExp('${id}')">‚ñ∂ Ejecutar</button>
        <button class="btn ghost" onclick="goToLab()">Cancelar</button>
      </div>
    </div>
  `;
  speak(exp.desc + " Pulsa Ejecutar.");
}

function runExp(id){
  const exp = experiments[id];
  playSound('click');
  // Simular proceso
  $('btnRunExp').disabled = true;
  $('btnRunExp').textContent = "Analizando...";
  
  setTimeout(()=>{
    exp.apply();
    state.completed[id] = true;
    playSound('win');
    $('expText').innerHTML = `<strong>Conclusi√≥n:</strong> ${exp.result}`;
    $('btnRunExp').style.display = 'none';
    
    // Bot√≥n continuar
    const btnCont = document.createElement('button');
    btnCont.className = 'btn good';
    btnCont.textContent = 'Anotar y Volver';
    btnCont.onclick = goToLab;
    $('gameContent').querySelector('.card').appendChild(btnCont);
    
    speak("An√°lisis completo. " + exp.result);
  }, 1500);
}

// 4. DESAF√çO FINAL (Quiz)
function startQuiz(){
  state.currentStage = 'quiz';
  setRoom('mode-lab');
  state.quizIndex = 0;
  state.quizScore = 0;
  renderQuestion();
}

function renderQuestion(){
  if(state.quizIndex >= quizData.length){
    showEndGame();
    return;
  }
  
  const q = quizData[state.quizIndex];
  $('stageTitle').textContent = "El Gran Desaf√≠o Final";
  $('stageTag').textContent = `Pregunta ${state.quizIndex+1}/${quizData.length}`;
  
  $('gameContent').innerHTML = `
    <div class="card">
      <p class="narrative-text" style="font-size:1.3rem">${q.q}</p>
      <div class="quiz-opts">
        ${q.opts.map((opt, idx) => `
          <button class="q-btn" onclick="checkAnswer(${idx}, this)">
            <span style="font-size:2rem">${opt.i}</span>
            <strong>${opt.txt}</strong>
          </button>
        `).join('')}
      </div>
    </div>
  `;
  speak(q.q);
}

function checkAnswer(idx, btn){
  const q = quizData[state.quizIndex];
  if(idx === q.correct){
    btn.classList.add('correct');
    state.quizScore++;
    playSound('win');
    speak("¬°Correcto!");
  } else {
    btn.classList.add('wrong');
    playSound('err');
    speak("Incorrecto. Intenta recordar.");
  }
  
  setTimeout(()=>{
    state.quizIndex++;
    renderQuestion();
  }, 1200);
}

function showEndGame(){
  const won = state.quizScore === quizData.length;
  state.currentStage = 'win';
  setRoom(won ? 'mode-park' : 'mode-dark');
  
  $('stageTitle').textContent = won ? "¬°MISI√ìN CUMPLIDA!" : "Buen Intento";
  $('gameContent').innerHTML = `
    <div class="card" style="text-align:center">
      <div style="font-size:4rem; margin-bottom:10px">${won ? 'üèÜ' : 'ü§î'}</div>
      <h2 style="color:${won ? 'var(--ok)' : 'var(--warning)'}">
        ${won ? '¬°Eres un Maestro del Bienestar!' : 'Te falt√≥ poco'}
      </h2>
      <p class="narrative-text">
        ${won 
          ? "Has demostrado que sabes elegir cu√°ndo jugar con pantallas y cu√°ndo activar tu cuerpo. ¬°Felicidades!" 
          : "Has acertado " + state.quizScore + " de 3. Revisa tus notas y vuelve a intentarlo."}
      </p>
      <button class="btn primary" onclick="location.reload()">üîÑ Jugar de Nuevo</button>
    </div>
  `;
  if(won) speak("¬°Felicidades! Eres un maestro del bienestar.");
}

// LISTENERS
$('btnBigStart').onclick = () => { playSound('click'); startBriefing(); };
$('btnMap').onclick = () => { if(state.currentStage !== 'start') goToLab(); };
$('btnMute').onclick = function(){
  state.muted = !state.muted;
  this.textContent = state.muted ? "üîá Silencio" : "üîä Sonido ON";
};

// Init visual state
updateMeters(0,0,0);

</script>
</body>
</html>
